// notice_start
/*
 * Copyright 2015 Keith Woods
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
 // notice_end

!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):"object"==typeof exports?exports.esp=t():e.esp=t()}(this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={exports:{},id:r,loaded:!1};return e[r].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";t.EventStage=n(9),t.Router=n(25),t.model=n(7)},function(e,t,n){"use strict";var r=function(e){return e&&e.__esModule?e:{"default":e}},o=function(e){return e&&e.__esModule?e["default"]:e},i=o(n(29)),s=o(n(3)),u=r(n(30)),a=r(n(11));e.exports={disposables:i,Guard:s,logger:u,utils:a}},function(e,t,n){"use strict";var r=function(e){return e&&e.__esModule?e["default"]:e},o=function(){function e(e,t){for(var n in t){var r=t[n];r.configurable=!0,r.value&&(r.writable=!0)}Object.defineProperties(e,t)}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},s=n(1).Guard,u=r(n(8)),a=function(){function e(t,n){i(this,e),s.isDefined(t,"observe Required"),this._observe=t,this._router=n}return o(e,{observe:{value:function(){var e;if(1===arguments.length&&arguments[0]instanceof u)e=arguments[0];else{s.lengthIsAtLeast(arguments,1,"Incorrect args count of "+arguments.length);var t=arguments[0],n=arguments.length>=1?arguments[1]:void 0,r=arguments.length>=2?arguments[2]:void 0;e=new u(t,n,r)}return this._observe(e)}}},{create:{value:function(t,n){s.lengthIs(arguments,2,"Incorrect argument count on Observable");var r=function(e){return t(e)};return new e(r,n)}}}),e}();e.exports=a},function(e,t,n){"use strict";function r(e){if("undefined"==typeof e||""===e)throw new Error("Argument error");throw new Error(e)}var o=function(e){return e&&e.__esModule?e:{"default":e}},i=function(){function e(e,t){for(var n in t){var r=t[n];r.configurable=!0,r.value&&(r.writable=!0)}Object.defineProperties(e,t)}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},u=o(n(11)),a=function(){function e(){s(this,e)}return i(e,null,{isDefined:{value:function(e,t){"undefined"==typeof e&&r(t)}},isFalsey:{value:function(e,t){e&&r(t)}},lengthIs:{value:function(e,t,n){e.length!==t&&r(n)}},lengthGreaterThan:{value:function(e,t,n){e.length<t&&r(n)}},lengthIsAtLeast:{value:function(e,t,n){e.length<t&&r(n)}},isString:{value:function(e,t){u.isString(e)||r(t)}},isTrue:{value:function(e,t){e||r(t)}},isFunction:{value:function(e,t){"function"!=typeof e&&r(t)}},isNumber:{value:function(e,t){isNaN(e)&&r(t)}},isObject:{value:function(e,t){"object"!=typeof e&&r(t)}}}),e}();e.exports=a},function(e,t,n){"use strict";var r=function(e){return e&&e.__esModule?e["default"]:e},o=function(){function e(e,t){for(var n in t){var r=t[n];r.configurable=!0,r.value&&(r.writable=!0)}Object.defineProperties(e,t)}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},s=r(n(3)),u=function(){function e(t){i(this,e),s.isDefined(t,"disposable must be defined");var n;if("function"==typeof t)n={dispose:function(){t()}};else{if(!t.dispose||"function"!=typeof t.dispose)throw new Error("Item to dispose was neither a function nor had a dispose method.");n={dispose:function(){t.dispose&&"function"==typeof t.dispose&&t.dispose()}}}this._isDisposed=!1,this._disposable=n}return o(e,{isDisposed:{get:function(){return this._isDisposed}},dispose:{value:function(){!this._isDisposed&&this._disposable&&(this._isDisposed=!0,this._disposable.dispose())}}}),e}();e.exports=u},function(e,t){"use strict";var n=function(){function e(e,t){for(var n in t){var r=t[n];r.configurable=!0,r.value&&(r.writable=!0)}Object.defineProperties(e,t)}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),r=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},o=function(){function e(){r(this,e),this._checkIsLocked=function(){return!0}}return n(e,{ensureLocked:{value:function(){if(this._checkIsLocked())throw new Error("Model is locked, can't edit")}},isLocked:{get:function(){return this._checkIsLocked()}}}),e}();e.exports=o},function(e,t,n){"use strict";var r=function(e){return e&&e.__esModule?e["default"]:e},o=r(n(14)),i=r(n(15));e.exports={AsyncWorkCompleteEvent:o,SubModelChangedEvent:i}},function(e,t,n){"use strict";var r=function(e){return e&&e.__esModule?e["default"]:e},o=r(n(6)),i=r(n(12)),s=r(n(5)),u=r(n(13));e.exports={events:o,DisposableBase:i,ModelBase:s,ModelRootBase:u}},function(e,t,n){"use strict";var r=function(){function e(e,t){for(var n in t){var r=t[n];r.configurable=!0,r.value&&(r.writable=!0)}Object.defineProperties(e,t)}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},i=n(1).Guard,s=function(){function e(t,n,r){o(this,e),i.isDefined(t,"onObserve Required"),this._hasError=!1,this._hasCompleted=!1,this._onNext=t,this._onError=function(e){if("undefined"==typeof n||"function"!=typeof n)throw e;n(e)},this._onCompleted=function(){"undefined"!=typeof r&&"function"==typeof r&&r()}}return r(e,{onNext:{value:function(e,t,n){this._hasError||this._hasCompleted||this._onNext(e,t,n)}},onError:{value:function(e){this._hasError||(this._hasError=!0,this._onError(e))}},onCompleted:{value:function(){this._hasCompleted||(this._hasCompleted=!0,this._onCompleted())}}}),e}();e.exports=s},function(e,t){"use strict";var n=function(){function e(e,t){for(var n in t){var r=t[n];r.configurable=!0,r.value&&(r.writable=!0)}Object.defineProperties(e,t)}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),r=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},o=function(){function e(){r(this,e)}return n(e,null,{preview:{get:function(){return"preview"}},normal:{get:function(){return"normal"}},committed:{get:function(){return"committed"}}}),e}();e.exports=o},function(e,t){"use strict";var n=function(){function e(e,t){for(var n in t){var r=t[n];r.configurable=!0,r.value&&(r.writable=!0)}Object.defineProperties(e,t)}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),r=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},o=function(){function e(){r(this,e)}return n(e,null,{Idle:{get:function(){return"idle"}},PreEventProcessing:{get:function(){return"preEventProcessorDispatch"}},EventProcessorDispatch:{get:function(){return"eventProcessorDispatch"}},EventExecution:{get:function(){return"eventProcessorExecution"}},PostProcessing:{get:function(){return"postEventProcessorDispatch"}},DispatchModelUpdates:{get:function(){return"dispatchModelUpdates"}},Halted:{get:function(){return"halted"}}}),e}();e.exports=o},function(e,t){"use strict";function n(e,t){for(var n=e.length;n--;)e[n]===t&&e.splice(n,1)}function r(e){return"string"==typeof e||e instanceof String}function o(e){var t=Array.prototype.slice.call(arguments,1),n=e.replace(/{(\d+)}/g,function(e,n){return"undefined"!=typeof t[n]?t[n]:e});return n}t.removeAll=n,t.isString=r,t.format=o,Object.defineProperty(t,"__esModule",{value:!0})},function(e,t,n){"use strict";var r=function(e){return e&&e.__esModule?e["default"]:e},o=function(){function e(e,t){for(var n in t){var r=t[n];r.configurable=!0,r.value&&(r.writable=!0)}Object.defineProperties(e,t)}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},s=r(n(1)),u=function(){function e(){i(this,e),this._disposables=new s.disposables.CompositeDisposable}return o(e,{isDisposed:{get:function(){return this._disposables.isDisposed}},addDisposable:{value:function(e){this._disposables.add(e)}},dispose:{value:function(){this._disposables.dispose()}}}),e}();e.exports=u},function(e,t,n){"use strict";var r=function(e){return e&&e.__esModule?e["default"]:e},o=function(){function e(e,t){for(var n in t){var r=t[n];r.configurable=!0,r.value&&(r.writable=!0)}Object.defineProperties(e,t)}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function f(e,t,n){var r=Object.getOwnPropertyDescriptor(e,t);if(void 0===r){var o=Object.getPrototypeOf(e);return null===o?void 0:f(o,t,n)}if("value"in r&&r.writable)return r.value;var i=r.get;return void 0===i?void 0:i.call(n)},s=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)},u=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},a=r(n(5)),c=function(e){function t(){u(this,t),i(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this._isLocked=!0,this._checkIsLocked=function(){return this._isLocked}.bind(this)}return s(t,e),o(t,{lock:{value:function(){this._isLocked=!0}},unlock:{value:function(){this._isLocked=!1}},bindLockPredicate:{value:function(){this._bindLockPredicate(this)}},_bindLockPredicate:{value:function(e){e=e||this;for(var t in e)if(e.hasOwnProperty(t)){var n=e[t];n instanceof a&&(n._checkIsLocked=this._checkIsLocked,this._bindLockPredicate(n))}}}}),t}(a);e.exports=c},function(e,t){"use strict";var n=function(){function e(e,t){for(var n in t){var r=t[n];r.configurable=!0,r.value&&(r.writable=!0)}Object.defineProperties(e,t)}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),r=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},o=function(){function e(t,n,o){r(this,e),this._operationId=t,this._results=n,this._isFinished=o}return n(e,{operationId:{get:function(){return this._operationId}},results:{get:function(){return this._results}},isFinished:{get:function(){return this._isFinished}}}),e}();e.exports=o},function(e,t){"use strict";var n=function(){function e(e,t){for(var n in t){var r=t[n];r.configurable=!0,r.value&&(r.writable=!0)}Object.defineProperties(e,t)}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),r=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},o=function(){function e(t,n){r(this,e),this._childModelId=t,this._eventType=n}return n(e,{childModelId:{get:function(){return this._childModelId}},eventType:{get:function(){return this._eventType}}}),e}();e.exports=o},function(e,t,n){"use strict";function r(e){var t=this;return this._observers.push(e),{dispose:function(){c.removeAll(t._observers,e)}}}var o=function(e){return e&&e.__esModule?e["default"]:e},i=function(){function e(e,t){for(var n in t){var r=t[n];r.configurable=!0,r.value&&(r.writable=!0)}Object.defineProperties(e,t)}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=function d(e,t,n){var r=Object.getOwnPropertyDescriptor(e,t);if(void 0===r){var o=Object.getPrototypeOf(e);return null===o?void 0:d(o,t,n)}if("value"in r&&r.writable)return r.value;var i=r.get;return void 0===i?void 0:i.call(n)},u=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)},a=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},c=n(1).utils,f=o(n(2)),l=function(e){function t(e){a(this,t),s(Object.getPrototypeOf(t.prototype),"constructor",this).call(this,r.bind(this),e),this._observers=[],this._hasComplete=!1,this._hasError=!1}return u(t,e),i(t,{hasError:{get:function(){return this._hasError}},error:{get:function(){return this._error}},onNext:{value:function(e,t,n){if(!this._hasComplete)for(var r=this._observers.slice(0),o=0,i=r.length;i>o&&!this._hasError;o++){var s=r[o];try{s.onNext(e,t,n)}catch(u){this._hasError=!0,this._error=u,s.onError(u)}}}},onCompleted:{value:function(){if(!this._hasComplete&&!this._hasError){this._hasComplete=!0;for(var e=this._observers.slice(0),t=0,n=e.length;n>t;t++){var r=e[t];r.onCompleted()}}}},onError:{value:function(e){if(!this._hasError){this._hasError=!0;for(var t=this._observers.slice(0),n=0,r=t.length;r>n;n++){var o=t[n];o.onError(e)}}}},getObserverCount:{value:function(){return this._observers.length}}}),t}(f);e.exports=l},function(e,t,n){"use strict";var r=function(e){return e&&e.__esModule?e["default"]:e},o=r(n(2));o.prototype.asObservable=function(){var e=this,t=function(t){return e.observe(function(e,n,r){t.onNext(e,n,r)},t.onError.bind(t),function(){return t.onCompleted()})};return new o(t,this._router)}},function(e,t,n){"use strict";var r=function(e){return e&&e.__esModule?e["default"]:e},o=r(n(31)),i=r(n(2)),s=r(n(7)),u=n(1),a=(r(u),u.Guard),c=(u.utils,u.logger,u.disposables),f=c.CompositeDisposable,l=c.DictionaryDisposable,d=s.events.AsyncWorkCompleteEvent,h="asyncWorkCompleteEvent";i.prototype.beginWork=function(e){var t=this;a.isDefined(e,"action required, format: (ec : EventContext, done : (result : any) => { })");var n=this,r=new f,s=new l;r.add(s);var u=function(i){return r.add(n.observe(function(u,a,c){var f=c.modelId,l=o.v1(),v=t._router.getEventObservable(f,h).where(function(e,t){return t.operationId===l}).observe(function(e,t,n){r.isDisposed||(t.isFinished&&(v.dispose(),s.remove(l)),i.onNext(e,t,n))}),p=function(e,t){if(!r.isDisposed){t="undefined"===t?!0:t;var o=new d(l,e,t);n._router.publishEvent(f,h,o)}};s.add(l,v),e(u,a,c,p)},i.onError.bind(i),function(){return i.onCompleted()})),r};return new i(u,this._router)}},function(e,t,n){"use strict";var r=function(e){return e&&e.__esModule?e["default"]:e},o=r(n(2)),i=n(1).Guard;o.prototype["do"]=function(e){i.isFunction(e,"provided value isn't a function");var t=this,n=function(n){return t.observe(function(t,r,o){e(t,r,o),n.onNext(t,r,o)},n.onError.bind(n),function(){return n.onCompleted()})};return new o(n,this._router)}},function(e,t,n){"use strict";var r=function(e){return e&&e.__esModule?e["default"]:e},o=r(n(2)),i=n(1).Guard;o.prototype.take=function(e){i.isNumber(e,"provided value isn't a number");var t=this,n=0,r=!1,s=function(o){return t.observe(function(t,i,s){n++;var u=!e||e>=n;u&&o.onNext(t,i,s);var a=!e||n>=e;!r&&a&&(r=!0,o.onCompleted())},o.onError.bind(o),function(){return o.onCompleted()})};return new o(s,this._router)}},function(e,t,n){"use strict";var r=function(e){return e&&e.__esModule?e["default"]:e},o=r(n(2)),i=n(1).Guard;o.prototype.where=function(e){i.isDefined(e,"predicate Required");var t=this,n=function(n){return t.observe(function(t,r,o){e(t,r,o)&&n.onNext(t,r,o)},n.onError.bind(n),function(){return n.onCompleted()})};return new o(n,this._router)}},function(e,t,n){"use strict";var r=function(e){return e&&e.__esModule?e["default"]:e};Object.defineProperty(t,"__esModule",{value:!0}),n(21),n(17),n(18),n(20),n(19),t.Observable=r(n(2)),t.Observer=r(n(8)),t.Subject=r(n(16))},function(e,t,n){"use strict";var r=function(){function e(e,t){for(var n in t){var r=t[n];r.configurable=!0,r.value&&(r.writable=!0)}Object.defineProperties(e,t)}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},i=n(1).Guard,s=function(){function e(t,n,r){o(this,e),i.isString(t,"The modelId should be a string"),i.isString(n,"The eventType should be a string"),i.isDefined(r,"The event should be defined"),this._modelId=t,this._eventType=n,this._event=r,this._isCanceled=!1,this._isCommitted=!1}return r(e,{isCanceled:{get:function(){return this._isCanceled}},isCommitted:{get:function(){return this._isCommitted}},modelId:{get:function(){return this._modelId}},event:{get:function(){return this._event}},eventType:{get:function(){return this._eventType}},cancel:{value:function(){if(this._isCanceled)throw new Error("event is already cancelled");this._isCanceled=!0}},commit:{value:function(){if(this._isCommitted)throw"event is already committed";this._isCommitted=!0}}}),e}();e.exports=s},function(e,t,n){"use strict";var r=function(){function e(e,t){for(var n in t){var r=t[n];r.configurable=!0,r.value&&(r.writable=!0)}Object.defineProperties(e,t)}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},i=n(1).Guard,s=function(){function e(t,n,r,i){o(this,e),this._parentModelId=t,this._modelId=n,this._model=r,this._eventQueue=[],this._hasChanges=!1,this._wasRemoved=!1,this._runPreEventProcessor=this._createEventProcessor("preEventProcessor",i?i.preEventProcessor:void 0),this._runPostEventProcessor=this._createEventProcessor("postEventProcessor",i?i.postEventProcessor:void 0),this._childrenIds=[]}return r(e,{parentModelId:{get:function(){return this._parentModelId}},modelId:{get:function(){return this._modelId}},model:{get:function(){return this._model}},eventQueue:{get:function(){return this._eventQueue}},hasChanges:{get:function(){return this._hasChanges},set:function(e){this._hasChanges=e}},wasRemoved:{get:function(){return this._wasRemoved},set:function(e){this._wasRemoved=e}},runPreEventProcessor:{get:function(){return this._runPreEventProcessor}},runPostEventProcessor:{get:function(){return this._runPostEventProcessor}},childrenIds:{get:function(){return this._childrenIds}},_createEventProcessor:{value:function(e,t){if(t){var n="function"==typeof t||"function"==typeof t.process;return i.isTrue(n,e+" should be a function or an object with a process() function"),function(n,r,o){if("function"==typeof t)t(n,r,o);else{if("function"!=typeof t.process)throw new Error(e+" is neither a function or an object with a process() method");t.process(n,r,o)}}}return function(){}}}}),e}();e.exports=s},function(e,t,n){"use strict";var r=function(e){return e&&e.__esModule?e["default"]:e},o=function(){function e(e,t){for(var n in t){var r=t[n];r.configurable=!0,r.value&&(r.writable=!0)}Object.defineProperties(e,t)}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},s=r(n(23)),u=r(n(9)),a=r(n(24)),c=r(n(26)),f=r(n(10)),l=n(22),d=l.Subject,h=l.Observable,v=n(6).SubModelChangedEvent,p=n(1),_=p.Guard,g=p.utils,m=p.logger,b=m.create("Router"),w=function(){function e(){i(this,e),this._models={},this._modelUpdateSubjects={},this._modelEventSubjects={},this._haltingException=void 0,this._state=new c}return o(e,{registerModel:{value:function(e,t,n){this._throwIfHalted(),_.isString(e,"The modelId argument should be a string"),_.isDefined(t,"THe model argument must be defined"),n&&_.isObject(n,"The options argument should be an object"),_.isFalsey(this._models[e],"The model with id ["+e+"] is already registered"),this._models[e]=new a(void 0,e,t,n)}},addChildModel:{value:function(e,t,n,r){this._throwIfHalted(),_.isString(e,"The parentModelId argument should be a string"),_.isString(t,"The childModelId argument should be a string"),_.isDefined(n,"The model argument should be defined"),r&&_.isObject(r,"The options argument should be an object");var o=this._models[e];if(!o)throw new Error("Parent model with id ["+e+"] is not registered");this._models[t]=new a(e,t,n,r),o.childrenIds.push(t)}},removeModel:{value:function(e){_.isString(e,"The modelId argument should be a string");var t=this._models[e];if(t){t.wasRemoved=!0,delete this._models[e],t.eventQueue.length=0;var n=this._modelUpdateSubjects[e];n&&(delete this._modelUpdateSubjects[e],n.onCompleted());var r=this._modelEventSubjects[e];if(r){delete this._modelEventSubjects[e];for(var o in r)if(r.hasOwnProperty(o)){var i=r[o];i.preview.onCompleted(),i.normal.onCompleted(),i.committed.onCompleted()}}for(var s=0,u=t.childrenIds.length;u>s;s++){var a=t.childrenIds[s];this.removeModel(a)}if(t.parentModelId){var c=this._models[t.parentModelId];if(c)for(var s=0;s<c.childrenIds.length;s++)if(c.childrenIds[s]===e){c.childrenIds.splice(s,1);break}}}}},publishEvent:{value:function(e,t,n){if(_.isString(e,"The modelId argument should be a string"),_.isString(t,"The eventType argument should be a string"),_.isDefined(n,"The event argument must be defined"),this._throwIfHalted(),this._state.currentStatus===f.EventExecution)throw new Error("You can not publish further events when performing an event execution. modelId1: ["+e+"], eventType:["+t+"]");var r=this._models[e];if("undefined"==typeof r)throw new Error("Can not publish event of type ["+t+"] as model with id ["+e+"] not registered");try{r.eventQueue.push({eventType:t,event:n}),this._purgeEventQueues()}catch(o){this._halt(o)}}},broadcastEvent:{value:function(e,t){_.isString(e,"The eventType argument should be a string"),_.isDefined(t,"The event argument should be defined");for(var n in this._models)if(this._models.hasOwnProperty(n)){var r=this._models[n];r.eventQueue.push({eventType:e,event:t}),this._purgeEventQueues()}}},executeEvent:{value:function(e,t){var n=this;this._throwIfHalted(),_.isString(e,"The eventType argument should be a string"),_.isDefined(t,"The event argument should be defined"),this._state.executeEvent(function(){var r=new s(n._state.currentModelId,e,t);n._dispatchEventToEventProcessors(n._state.currentModelId,n._state.currentModel,t,e,r)})}},getEventObservable:{value:function(e,t,n){var r=this;return h.create(function(o){r._throwIfHalted(),_.isString(e,"The modelId argument should be a string"),_.isDefined(e,"The modelId argument should be defined"),_.isDefined(t,"The eventType argument should be defined"),n?(_.isString(n,"The stage argument should be a string"),_.isTrue(n===u.preview||n===u.normal||n===u.committed,"The stage argument value of ["+n+"] is incorrect. It should be preview, normal or committed.")):n=u.normal;var i=r._getModelsEventSubjects(e,t),s=i[n];return s.observe(o)},this)}},getModelObservable:{value:function(e){var t=this;return h.create(function(n){t._throwIfHalted(),_.isString(e,"The modelId should be a string");var r=t._modelUpdateSubjects[e];return"undefined"==typeof r&&(r=new d(t),t._modelUpdateSubjects[e]=r),r.observe(n)},this)}},_getModelsEventSubjects:{value:function(e,t){var n=this._modelEventSubjects[e];"undefined"==typeof n&&(n={},this._modelEventSubjects[e]=n);var r=n[t];return"undefined"==typeof r&&(r={preview:new d(this),normal:new d(this),committed:new d(this)},n[t]=r),r}},_purgeEventQueues:{value:function(){if(this._state.currentStatus===f.Idle){for(var e=this._getNextModelRecordWithQueuedEvents(),t=!0;t;){for(;t;){this._state.moveToPreProcessing(e.modelId,e.model);var n=e.eventQueue.shift();e.model.unlock&&"function"==typeof e.model.unlock&&e.model.unlock();var r=new s(e.modelId,n.eventType,n.event);if(e.runPreEventProcessor(e.model,n.event,r),!e.wasRemoved){if(!r.isCanceled)for(this._state.moveToEventDispatch();t;){var o=this._dispatchEventToEventProcessors(e.modelId,e.model,n.event,n.eventType,r);if(e.wasRemoved)break;!e.hasChanges&&o&&(e.hasChanges=!0),t=e.eventQueue.length>0,t&&(n=e.eventQueue.shift(),r=new s(e.modelId,n.eventType,n.event))}e.wasRemoved||(this._state.moveToPostProcessing(),e.runPostEventProcessor(e.model,n.event,r),e.model.lock&&"function"==typeof e.model.lock&&e.model.lock())}e.parentModelId?(this.publishEvent(e.parentModelId,"modelChangedEvent",new v(e.modelId,n.eventType)),e=this._models[e.parentModelId],t=!0):(e=this._getNextModelRecordWithQueuedEvents(),t="undefined"!=typeof e)}this._state.moveToDispatchModelUpdates(),this._dispatchModelUpdates(),e=this._getNextModelRecordWithQueuedEvents(),t="undefined"!=typeof e}this._state.moveToIdle()}}},_dispatchEventToEventProcessors:{value:function(e,t,n,r,o){var i=function(e,t,n,r){var o=!1;if(r.getObserverCount()>0){if(r.onNext(e,t,n),r.hasError)throw r.error;o=!0}return o},s=this._getModelsEventSubjects(e,r),u=i(t,n,o,s.preview);if(o.isCommitted)throw new Error("You can't commit an event at the preview stage. Event: ["+o.eventType+"], ModelId: ["+e+"]");if(!o.isCanceled){if(u=i(t,n,o,s.normal),o.isCanceled)throw new Error("You can't cancel an event at the normal stage. Event: ["+o.eventType+"], ModelId: ["+e+"]");if(u&&o.isCommitted&&(i(t,n,o,s.committed),o.isCanceled))throw new Error("You can't cancel an event at the committed stage. Event: ["+o.eventType+"], ModelId: ["+e+"]")}return u}},_dispatchModelUpdates:{value:function(){var e=[],t=void 0;for(var n in this._models)if(this._models.hasOwnProperty(n)){var r=this._models[n];r.hasChanges&&(r.hasChanges=!1,e.push(r))}for(var o=0,i=e.length;i>o;o++)if(t=this._modelUpdateSubjects[e[o].modelId],"undefined"!=typeof t&&(t.onNext(e[o].model),t.hasError))throw t.error}},_getNextModelRecordWithQueuedEvents:{value:function(){var e=void 0;for(var t in this._models)if(this._models.hasOwnProperty(t)){var n=this._models[t];if(n.eventQueue.length>0){e=n;break}}return e}},_throwIfHalted:{value:function(){if(this._state.currentStatus===f.Halted){var e=g.format("Event router halted due to previous error [{0}]",this._haltingException);throw new Error(e)}}},_halt:{value:function(e){throw this._state.moveToHalted(),b.error("Router halted error: [{0}]",e),this._haltingException=e,e}}}),e}();e.exports=w},function(e,t,n){"use strict";var r=function(e){return e&&e.__esModule?e["default"]:e},o=function(){function e(e,t){for(var n in t){var r=t[n];r.configurable=!0,r.value&&(r.writable=!0)}Object.defineProperties(e,t)}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},s=n(1).Guard,u=r(n(10)),a=function(){function e(){i(this,e),this._currentStatus=u.Idle}return o(e,{currentStatus:{get:function(){return this._currentStatus}},currentModelId:{get:function(){return this._currentModelId}},currentModel:{get:function(){return this._currentModel}},moveToIdle:{value:function(){this._currentStatus=u.Idle,this._clear()}},moveToPreProcessing:{value:function(e,t){s.isString(e,"The modelId should be a string"),s.isDefined(t,"The model should be defined"),this._currentModelId=e,this._currentModel=t,this._currentStatus=u.PreEventProcessing}},moveToEventDispatch:{value:function(){this._currentStatus=u.EventProcessorDispatch}},moveToPostProcessing:{value:function(){this._currentStatus=u.PostProcessing}},executeEvent:{value:function(e){var t=this._currentStatus===u.PreEventProcessing||this._currentStatus===u.EventProcessorDispatch||this._currentStatus===u.PostProcessing;s.isTrue(t,"Can't move to executing as the current state "+this._currentStatus+" doesn't allow it");var n=this._currentStatus;this._currentStatus=u.EventExecution,e(),this._currentStatus=n}},moveToDispatchModelUpdates:{value:function(){this._currentStatus=u.DispatchModelUpdates}},moveToHalted:{value:function(){this._currentStatus=u.Halted,this._clear()}},_clear:{value:function(){this._currentModelId=void 0,this._currentModel=void 0}}}),e}();e.exports=a},function(e,t,n){"use strict";var r=function(e){return e&&e.__esModule?e["default"]:e},o=function(){function e(e,t){for(var n in t){var r=t[n];r.configurable=!0,r.value&&(r.writable=!0)}Object.defineProperties(e,t)}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},s=(r(n(3)),r(n(4))),u=function(){function e(){i(this,e),this._disposables=[],this._isDisposed=!1}return o(e,{isDisposed:{get:function(){return this._isDisposed}},add:{value:function(e){var t=new s(e);return this._isDisposed?void t.dispose():void this._disposables.push(t)}},dispose:{value:function(){if(!this._isDisposed){this._isDisposed=!0;for(var e=0,t=this._disposables.length;t>e;e++){var n=this._disposables[e];n.dispose()}this._disposables.length=0}}}}),e}();e.exports=u},function(e,t,n){"use strict";var r=function(e){return e&&e.__esModule?e["default"]:e},o=function(){function e(e,t){for(var n in t){var r=t[n];r.configurable=!0,r.value&&(r.writable=!0)}Object.defineProperties(e,t)}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},s=r(n(4)),u=function(){function e(){i(this,e),this._isDisposed=!1}return o(e,{add:{value:function(e,t){if(this.hasOwnProperty(e))throw new Error("Key "+e+" already found");var n=new s(t);return this._isDisposed?void n.dispose():void(this[e]=n)}},remove:{value:function(e){this.hasOwnProperty(e)&&delete this[e]}},dispose:{value:function(){this._isDisposed=!0;for(var e in this)if(this.hasOwnProperty(e)){var t=this[e];t.dispose&&t.dispose()}}}}),e}();e.exports=u},function(e,t,n){"use strict";var r=function(e){return e&&e.__esModule?e["default"]:e},o=r(n(27)),i=r(n(28)),s=r(n(4));e.exports={CompositeDisposable:o,DictionaryDisposable:i,DisposableWrapper:s}},function(e,t,n){"use strict";function r(e){return c.isDefined(e,"The name argument should be defined"),c.isString(e,"The name argument should be a string"),new h(e)}function o(e){l=e}function i(e){c.isFunction(e,"Logging sink argument must be a function"),d=e}var s=function(e){return e&&e.__esModule?e["default"]:e},u=function(){function e(e,t){for(var n in t){var r=t[n];r.configurable=!0,r.value&&(r.writable=!0)}Object.defineProperties(e,t)}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};t.create=r,t.setLevel=o,t.setSink=i,Object.defineProperty(t,"__esModule",{value:!0});var c=s(n(3)),f={verbose:0,debug:1,info:2,warn:3,error:4},l=f.debug,d=function(e){console.log("["+e.logger+"] ["+e.level+"]: "+e.message)},h=function(){function e(t){a(this,e),this._name=t}return u(e,{verbose:{value:function(e){if(l<=f.verbose){var t=Array.prototype.slice.call(arguments,1);this._log("VERBOSE",e,t)}}},debug:{value:function(e){if(l<=f.debug){var t=Array.prototype.slice.call(arguments,1);this._log("DEBUG",e,t)}}},info:{value:function(e){if(l<=f.info){var t=Array.prototype.slice.call(arguments,1);this._log("INFO",e,t)}}},warn:{value:function(e){if(l<=f.warn){var t=Array.prototype.slice.call(arguments,1);this._log("WARN",e,t)}}},error:{value:function(e){if(l<=f.error){var t=Array.prototype.slice.call(arguments,1);this._log("ERROR",e,t)}}},_log:{value:function(e,t,n){c.isString(t,"First argument to a log function should be a string, but got ["+t+"]");var r=t.replace(/{(\d+)}/g,function(e,t){return"undefined"!=typeof n[t]?n[t]:e});d({logger:this._name,level:e,message:r})}}}),e}();t.levels=f},function(e,t,n){var r;(function(){function o(e,t,n){var r=t&&n||0,o=0;for(t=t||[],e.toLowerCase().replace(/[0-9a-f]{2}/g,function(e){16>o&&(t[r+o++]=_[e])});16>o;)t[r+o++]=0;return t}function i(e,t){var n=t||0,r=p;return r[e[n++]]+r[e[n++]]+r[e[n++]]+r[e[n++]]+"-"+r[e[n++]]+r[e[n++]]+"-"+r[e[n++]]+r[e[n++]]+"-"+r[e[n++]]+r[e[n++]]+"-"+r[e[n++]]+r[e[n++]]+r[e[n++]]+r[e[n++]]+r[e[n++]]+r[e[n++]]}function s(e,t,n){var r=t&&n||0,o=t||[];e=e||{};var s=null!=e.clockseq?e.clockseq:w,u=null!=e.msecs?e.msecs:(new Date).getTime(),a=null!=e.nsecs?e.nsecs:E+1,c=u-y+(a-E)/1e4;if(0>c&&null==e.clockseq&&(s=s+1&16383),(0>c||u>y)&&null==e.nsecs&&(a=0),a>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");y=u,E=a,w=s,u+=122192928e5;var f=(1e4*(268435455&u)+a)%4294967296;o[r++]=f>>>24&255,o[r++]=f>>>16&255,o[r++]=f>>>8&255,o[r++]=255&f;var l=u/4294967296*1e4&268435455;o[r++]=l>>>8&255,o[r++]=255&l,o[r++]=l>>>24&15|16,o[r++]=l>>>16&255,o[r++]=s>>>8|128,o[r++]=255&s;for(var d=e.node||b,h=0;6>h;h++)o[r+h]=d[h];return t?t:i(o)}function u(e,t,n){var r=t&&n||0;"string"==typeof e&&(t="binary"==e?new v(16):null,e=null),e=e||{};var o=e.random||(e.rng||a)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t)for(var s=0;16>s;s++)t[r+s]=o[s];return t||i(o)}var a,c=this;if("function"==typeof c.require)try{
var f=c.require("crypto").randomBytes;a=f&&function(){return f(16)}}catch(l){}if(!a&&c.crypto&&crypto.getRandomValues){var d=new Uint8Array(16);a=function(){return crypto.getRandomValues(d),d}}if(!a){var h=new Array(16);a=function(){for(var e,t=0;16>t;t++)0===(3&t)&&(e=4294967296*Math.random()),h[t]=e>>>((3&t)<<3)&255;return h}}for(var v="function"==typeof c.Buffer?c.Buffer:Array,p=[],_={},g=0;256>g;g++)p[g]=(g+256).toString(16).substr(1),_[p[g]]=g;var m=a(),b=[1|m[0],m[1],m[2],m[3],m[4],m[5]],w=16383&(m[6]<<8|m[7]),y=0,E=0,P=u;if(P.v1=s,P.v4=u,P.parse=o,P.unparse=i,P.BufferClass=v,"undefined"!=typeof e&&e.exports)e.exports=P;else{r=function(){return P}.call(t,n,t,e),!(void 0!==r&&(e.exports=r))}}).call(this)}])});